%!TEX root = ./main.tex

\section{Compositional Semantics}
\label{sec:semantics}

We extend the transition system semantics of labelled Petri nets defined in Sect.~\ref{subsec:basics} to AIOPNs.
For this purpose we introduce asynchronous I/O-transition systems which are
labelled transition systems extended by channels and a \emph{channel valuation} function $\val: Q  \goes{} \N^{\chan}$.
The channel valuation function determines for each state $q \in Q$ how many messages are actually pending
on each channel $a \in C$. 
For $q \in Q$ and $a \in C$ we use the notation $\val(q)[a\mathrm{++}]$ to denote the updated map

%$\vec{v}[a \mapsto n]: \chan \mapsto \N$
\[
    \val(q)[a\mathrm{++}](x) = \begin{cases}
        \val(q)(a)+1 &\text{ if } x = a,\\
        \val(q)(x) &\text{ otherwise. }
    \end{cases}
\]

The updated map $\val(q)[a\mathrm{--}]$ is defined similarly. Instead of $\val(q)(a)$ we will often write $\val(q,a)$.

\begin{definition}[Asynchronous I/O-transition system]\label{def:aiots}
    An \emph{asynchronous I/O-transition system} (\AIOTS) is a tuple $\S = (\chan, \Sigma,Q,q^0,\goes{},\val)$, such that
    \begin{itemize}
        \item $(\Sigma, Q, q^0, \goes{})$ is a labelled transition system, 
        \item \chan is a finite set of channels,
        \item $\Sigma = \inset \uplus \outset \uplus \com$ is an I/O-alphabet over \chan,
        \item $\val: Q  \goes{} \N^{\chan}$ is a function, such that for all $a \in \chan, q,q' \in Q$:
        \begin{itemize}
            \item $\val(q^0,a) = 0$,
            \item $q \goes{\outact{a}} q' \implies \val(q') = \val(q)[a\mathrm{++}]$,
            \item $q \goes{\inact{a}} q' \implies \val(q,a) > 0 
            \text{ and } \val(q') = \val(q)[a\mathrm{--}]$, and
            \item for all $x \in (\inset \cup \outset), q \goes{x} q' \implies \val(q') = \val(q)$. 
        \end{itemize}
    \end{itemize}
\end{definition}

The first condition for $\val$ assumes that initially all communication channels are empty.
 The second condition states that transitions with labels $\outact{a}$ and $\inact{a}$ have the desired effect
of putting one message on a channel (consuming one message from a channel resp.). 
The last condition requires that the input and output actions of an open system do not change the valuation of any channel.
% (since channels are used for the communication \emph{inside} the system).
Sometimes we need to reason about the number of messages on a subset $B \subseteq \chan$ of the channels in a state $q \in Q$. We define $\val(q,B) = \sum_{a \in B} \val(q,a)$.

The semantics of an asynchronous I/O-Petri net $\pnN$ is given by its \emph{associated} asynchronous I/O-transition system $\aiots(\pnN)$.
It is based on the transition system semantics of a labelled Petri net (see Sect.~\ref{subsec:basics}) such that
markings become states, but additionally we define the valuation of a channel in a current state $m$ by the number of tokens on the channel
under the marking $m$.

\begin{definition}[Associated asynchronous I/O-transition system]\label{def:assoc-aiots}
    Let $\pnN = \apntup{}$ be an \AIOPN. The \AIOTS \emph{associated with} $\pnN$ is given by $\aiots(\pnN) = (\chan, \Sigma,Q,q^0,\goes{},\val)$, such that
    \begin{itemize}
%        \item $(\Sigma,Q,q^0,\goes{})$ is the labeled transition system generated by $\pntup{}$ and
        \item $(\Sigma,Q,q^0,\goes{}) = \lts\pntup{}$,
        \item for all $a \in \chan$ and $m \in Q, \val(m,a) = m(a).$ 
    \end{itemize}
\end{definition}

\begin{figure}
    \centering
    \input{papers/petrinets/figures/state-space-example.tex}
    \caption{Part of the associated AIOTS for $\pnN_3$ in Fig.~\ref{fig:ex-aiopn}.}\label{fig:ex-associatedAIOTS}
\end{figure}
\begin{example}\label{ex:aiots}
 The transition systems associated with the \AIOPNs $\pnN_1$ and $\pnN_2$ in Fig.~\ref{fig:ex-aiopn1} and~\ref{fig:ex-aiopn2}
 have two reachable states and the transitions between them correspond directly to their Petri net representations. 
The situation is different for the AIOPN $\pnN_3$ in Fig.~\ref{fig:ex-aiopn}. It has infinitly many reachable markings
and hence its associated AIOTS has infinitely many reachable states. 
Fig.~\ref{fig:ex-associatedAIOTS} shows an excerpt of it. 
The states indicate the number of tokens in each place in the order $p_0, p_1, msg, p_2, p_3$. The initial state is underlined.
\end{example}


Like AIOPNs also two AIOTSs can be asynchronously composed, if their underlying I/O-alphabets are composable. The composition is constructed by introducing a new communication channel
for each shared input/output action and by appropriate transitions for the corresponding communication actions that modify the valuation of the new channels (see items 3 and 4 in Def.~\ref{def:async-comp-aiots}). %It relies on a binary communication style.
Since the states of the composition must record the number of messages on the new channels $\chan_{\S\T}$, the state space of the composition adds to the Cartesian product of the underlying state spaces the set $\N^{\chan_{\S\T}}$ of valuations of the new channels. 
For a valuation $\vec{v}: \chan_{\S\T} \mapsto \N$ and channel $a \in \chan_{\S\T}$ we use the notation $\vec{v}[a\mathrm{++}]$ ($\vec{v}[a\mathrm{--}]$ resp.) to denote the updated map which increments (decrements) the value of $a$ by 1 and leaves the values of all other channels unchanged.

%For a valuation $\vec{v}: \chan_{\S\T} \mapsto \N$, we use the notation $\vec{v}[a \mapsto n]$ to denote the updated map
%%$\vec{v}[a \mapsto n]: \chan \mapsto \N$
%$\vec{v}[a \mapsto n](x) = \begin{cases}
%    n &\text{ if } x = a,\\
%    \vec{v}(x) &\text{ otherwise. }
%\end{cases}$
%
%\begin{definition}[Asynchronous composition of \AIOTS]\label{def:async-comp-aiots}
%\\Let $\S = \aiotstup{\S}$ and $\T = \aiotstup{\T}$ be two \AIOTSs. $\S$ and $\T$ are composable if $\Sigma_\S$ and $\Sigma_\T$ are composable. In this case their asynchronous composition is the \AIOTS $\S \compos \T = \aiotstup{}$ defined as follows:
%\begin{itemize}
%    \item $\chan = \chan_\S \uplus \chan_\T \uplus \chan_{\S\T}$, with $\chan_{\S\T} = \Sigma_\S \cap \Sigma_\T$,
%    \item $\Sigma$ is the alphabet composition of $\Sigma_\S$ and $\Sigma_\T$,
%    \item $Q = Q_\S \times Q_\T \times \N^{\chan_{\S\T}} $,
%    \item $q^0= (q^0_\S,q^0_\T,\vec{0})$, with $\vec{0}$ being the zero-map,
%    \item $\goes{}$ is inductively defined as follows for all $(q_\S,q_\T,\vec{v}) \in Q $:
%\vspace{1mm}
%    \begin{enumerate}[label=\arabic*:, ref=(\arabic*), leftmargin=*]
%        \item\label{def:trans:s} For all $a \in (\Sigma_\S \setminus \chan_{\S\T}) %\cup \{\tau\}
%        $,
%                if $q_\S \goes{a}_\S q'_\S$ then $(q_\S, q_\T, \vec{v}) \goes{a} (q'_\S, q_\T, \vec{v})$.
%\vspace{1mm}
%        \item\label{def:trans:t} For all $a \in (\Sigma_\T \setminus \chan_{\S\T}) %\cup \{\tau\}
%        $,
%                if $q_\T \goes{a}_\T q'_\T$ then $(q_\S, q_\T, \vec{v}) \goes{a} (q_\S, q'_\T, \vec{v})$.
%\vspace{1mm}
%        \item\label{def:trans:stot} For all $a \in \inset_\S \cap \outset_\T$,
%\vspace{1mm}
%                \begin{enumerate}[label=3.\arabic*:, ref=(3.\arabic*), leftmargin=*]
%                    \item\label{def:trans:stots} if $q_\S \goes{a}_\S q'_\S$  and $\vec v (a) > 0$\\
% then $(q_\S, q_\T, \vec{v}) \goes{\inact{a}} (q'_\S, q_\T, \vec{v}[a \mapsto (\vec v (a) - 1)])$,
%                    \item\label{def:trans:stott} if $q_\T \goes{a}_\T q'_\T$ then $(q_\S, q_\T, \vec{v}) \goes{\outact{a}} (q_\S, q'_\T, \vec{v}[a \mapsto (\vec v (a) + 1)])$.
%                \end{enumerate}
%\vspace{1mm}
%        \item\label{def:trans:ttos} For all $a \in \inset_\T \cap \outset_\S$,
%                \begin{enumerate}[label=4.\arabic*:, ref=(4.\arabic*), leftmargin=*]
%                    \item\label{def:trans:ttoss} if $q_\S \goes{a}_\S q'_\S$ then $(q_\S, q_\T, \vec{v}) \goes{\outact{a}} (q'_\S, q_\T, \vec{v}[a \mapsto (\vec v (a) + 1)])$,
%                    \item\label{def:trans:ttost} if $q_\T \goes{a}_\T q'_\T$ and $\vec v (a) > 0$\\
%then $(q_\S, q_\T, \vec{v}) \goes{\inact{a}} (q_\S, q'_\T, \vec{v}[a \mapsto (\vec v (a) - 1)])$.
%                \end{enumerate}        
%    \end{enumerate}
%\vspace{1mm}
%    \item For all $(q_\S,q_\T,\vec{v}) \in Q$ and $a \in \chan$, \\
%    $ 
%    \val ((q_\S,q_\T,\vec{v}),a) =
%    \begin{cases}
%        \val_\S(q_\S,a) &\text{ if } a \in \chan_\S \\
%        \val_\T(q_\T,a) &\text{ if } a \in \chan_\T \\
%        \vec{v}(a)        &\text{ if } a \in \chan_{\S\T}
%    \end{cases} \qquad $ 
%\end{itemize}
%For the rules \ref{def:trans:s},\ref{def:trans:stots} and \ref{def:trans:ttoss}, we say that the resulting transition in the composition is \emph{triggered} by $\S$, in the other cases it is triggered by \T.
%Let $\rho$ be a trace of $\S\compos\T$ starting from a state $q = (q_\S,q_\T,\vec{v}) \in Q$. The \emph{projection} of $\rho$ to $\S$, denoted by $\rho|_\S$, is the sequence of transitions of $\S$, starting from $q_\S$, which have triggered corresponding transitions in $\rho$.
%
%\end{definition}
\begin{definition}[Asynchronous composition of \AIOTS]\label{def:async-comp-aiots}~\\
Let $\S = \aiotstup{\S}$ and $\T = \aiotstup{\T}$ be two \AIOTSs. $\S$ and $\T$ are composable if $\Sigma_\S$ and $\Sigma_\T$ are composable. In this case their asynchronous composition is the \AIOTS $\S \compos \T = \aiotstup{}$ defined as follows:
\begin{itemize}
    \item $\chan = \chan_\S \uplus \chan_\T \uplus \chan_{\S\T}$, with $\chan_{\S\T} = \Sigma_\S \cap \Sigma_\T$,
    \item $\Sigma$ is the alphabet composition of $\Sigma_\S$ and $\Sigma_\T$,
    \item $Q \subseteq Q_\S \times Q_\T \times \N^{\chan_{\S\T}} $,
    \item $q^0= (q^0_\S,q^0_\T,\vec{0}) \in Q$, with $\vec{0}$ being the zero-map,
    \item $Q$ and $\goes{}$ are inductively defined as follows for $(q_\S,q_\T,\vec{v}) \in Q $:
\vspace{1mm}
    \begin{enumerate}[label=\arabic*:, ref=(\arabic*), leftmargin=*]
        \item\label{def:trans:s} For all $a \in (\Sigma_\S \setminus \chan_{\S\T}) %\cup \{\tau\}
        $,
                if $q_\S \goes{a}_\S q'_\S$ then \\ $(q_\S, q_\T, \vec{v}) \goes{a} (q'_\S, q_\T, \vec{v})$ and $(q'_\S, q_\T, \vec{v}) \in Q$.
\vspace{1mm}
        \item\label{def:trans:t} For all $a \in (\Sigma_\T \setminus \chan_{\S\T}) %\cup \{\tau\}
        $,
                if $q_\T \goes{a}_\T q'_\T$ then \\ $(q_\S, q_\T, \vec{v}) \goes{a} (q_\S, q'_\T, \vec{v})$ and $(q_\S, q'_\T, \vec{v}) \in Q$.
\vspace{1mm}
        \item\label{def:trans:stot} For all $a \in \inset_\S \cap \outset_\T$,
\vspace{1mm}
                \begin{enumerate}[label=3.\arabic*:, ref=(3.\arabic*), leftmargin=*]
                    \item\label{def:trans:stots} if $q_\S \goes{a}_\S q'_\S$  and $\vec v (a) > 0$
 then \\ $(q_\S, q_\T, \vec{v}) \goes{\inact{a}} (q'_\S, q_\T, \vec{v}[a\mathrm{--}])$ and  $(q'_\S, q_\T, \vec{v}[a\mathrm{--}]) \in Q$,
                    \item\label{def:trans:stott} if $q_\T \goes{a}_\T q'_\T$ then \\ $(q_\S, q_\T, \vec{v}) \goes{\outact{a}} (q_\S, q'_\T, \vec{v}[a\mathrm{++}])$
and $(q_\S, q'_\T, \vec{v}[a\mathrm{++}]) \in Q$.
                \end{enumerate}
\vspace{1mm}
        \item\label{def:trans:ttos} For all $a \in \inset_\T \cap \outset_\S$,
                \begin{enumerate}[label=4.\arabic*:, ref=(4.\arabic*), leftmargin=*]
                    \item\label{def:trans:ttoss} if $q_\S \goes{a}_\S q'_\S$ then $(q_\S, q_\T, \vec{v}) \goes{\outact{a}} (q'_\S, q_\T, \vec{v}[a\mathrm{++}])$\\
and $(q'_\S, q_\T, \vec{v}[a\mathrm{++}]) \in Q,$
                    \item\label{def:trans:ttost} if $q_\T \goes{a}_\T q'_\T$ and $\vec v (a) > 0$
then\\ $(q_\S, q_\T, \vec{v}) \goes{\inact{a}} (q_\S, q'_\T, \vec{v}[a\mathrm{--}])$
and $(q_\S, q'_\T, \vec{v}[a\mathrm{--}]) \in Q$.
                \end{enumerate}        
    \end{enumerate}
\vspace{1mm}
    \item For all $(q_\S,q_\T,\vec{v}) \in Q$ and $a \in \chan$, \\
    $ 
    \val ((q_\S,q_\T,\vec{v}),a) =
    \begin{cases}
        \val_\S(q_\S,a) &\text{ if } a \in \chan_\S \\
        \val_\T(q_\T,a) &\text{ if } a \in \chan_\T \\
        \vec{v}(a)        &\text{ if } a \in \chan_{\S\T}
    \end{cases} \qquad $ 
\end{itemize}
For the rules \ref{def:trans:s},\ref{def:trans:stots} and \ref{def:trans:ttoss}, we say that the resulting transition in the composition is \emph{triggered} by $\S$.
Let $\rho$ be a trace of $\S\compos\T$ starting from a state $q = (q_\S,q_\T,\vec{v}) \in Q$. The \emph{projection} of $\rho$ to $\S$, denoted by $\rho|_\S$, is the sequence of transitions of $\S$, starting from $q_\S$, which have triggered corresponding transitions in $\rho$.

\end{definition}

We can now consider the class of all asynchronous I/O-transition systems that are generated by asynchronous I/O-Petri nets
and prove that this class is closed under asynchronous composition. This is a consequence of the fact that the generation of
AIOTSs from AIOPNs commutes with asynchronous composition. The proof of this theorem is technical, but straightforward.

% The following theorem shows that the transition system semantics of asynchronous I/O-Petri nets is compositional.
% The proof is given in Appendix~\ref{app:comp-semantics}. 
%This result will be used in the next section to obtain compositionality of the
%channel properties for asynchronously composed I/O-Petri nets.


\begin{theorem}\label{thm:comp-semantics}
  Let $\pnN$ and $\M$ be two composable \AIOPNs. Then it holds that
$\aiots(\pnN \compospn \M) = \aiots(\pnN) \compos \aiots(\M)$ (up to bijection between state spaces).
\end{theorem}
\begin{proof}
    We give a sketch of the proof. The full proof is technical but straightforward.
Let $\aiots(\pnN \compospn \M)= \aiotstup{A}$ and $\aiots(\pnN) \compos \aiots(\M) = \aiotstup{B}$. 
     It is clear by Def.~\ref{def:aync-comp-aiopn}, Def.~\ref{def:assoc-aiots} and Def.~\ref{def:async-comp-aiots} that 
     \[
     \chan_A = \chan_\pnN \uplus \chan_\M \uplus (\Sigma_\pnN \cap \Sigma_\M) = \chan_B.
     \]
     and that $\Sigma_A = \Sigma_B$.
     We will now consider the two state spaces. By Def.~\ref{def:assoc-aiots} a state in $Q_A$ is a reachable marking of $\pnN \compospn \M$, by Def.~\ref{def:aync-comp-aiopn} we get that the set of places of $\pnN \compospn \M$ is $P_\pnN \uplus P_\M \uplus \{\Sigma_\pnN \cap \Sigma_\M\}$. Thus, it follows that
     \[
        Q_A \subseteq \N^{P_\pnN \uplus P_\M \uplus \{\Sigma_\pnN \cap \Sigma_\M\}}.
     \]
     By Def.~\ref{def:async-comp-aiots} a state in $Q_B$ is a reachable state consisting of three parts, a state of $\aiots(\pnN) \subseteq \N^{P_\pnN}$, a state of $\aiots(\M) \subseteq \N^{P_\M}$, and the content of the new channels in their composition. Hence, 
     \[
        Q_B \subseteq \N^{P_\pnN} \times \N^{P_\M} \times \N^{\{\Sigma_\pnN \cap \Sigma_\M\}}.
     \]
   
Obviously, the two supersets $\N^{P_\pnN \uplus P_\M \uplus \{\Sigma_\pnN \cap \Sigma_\M\}}$ and
$\N^{P_\pnN} \times \N^{P_\M} \times \N^{\{\Sigma_\pnN \cap \Sigma_\M\}}$
are set-theoretically isomorphic.   
%We will now introduce a handy notation. We write $ m = \langle m_\pnN, m_\M, m_\chan \rangle \in \N^{P_\pnN \uplus P_\M \uplus \{\Sigma_\pnN \cap \Sigma_\M\}}$, $m_\pnN \in \N^\pnN$, $m_\M \in \N^\M$, and $m_\chan \in \N^{\{\Sigma_\pnN \cap \Sigma_\M\}}$. It should now be clear that the function $F: Q_A \goes{} Q_B$, defined such that $F(\langle m_\pnN, m_\M, m_\chan \rangle) = (m_\pnN, m_\M, m_\chan)$ is a bijection.
It remains to prove that the transition relations $\goes{}_A$ and $\goes{}_B$ are equal for isomorphic states which implies
also that $Q_A$ and  $Q_B$ are isomorphic.
Finally one must prove that the valuation functions coincide on isomorphic states. These two facts are straightforward but technical to prove on the basis of Def.~\ref{def:aync-comp-aiopn} and Def.~\ref{def:async-comp-aiots}.
\end{proof}
%The proof is given in Appendix~\ref{app:comp-semantics}. 
%The state spaces on each side can be easily related
%by a set-theoretic isomorphism since the semantics definition does not involve a restriction on reachable states.
