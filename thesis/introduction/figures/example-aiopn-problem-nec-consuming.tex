%!TEX root = ../../thesis.tex

\begin{tikzpicture}
\node[place,tokens=1,label=above:$q_0$] at (-1,-1.5) (p0) {};
\node[transition,rotate=90,label={[yshift=0,xshift=0]0:$\transition{\outact{msg}}$},enabled] at (1,-1.5) (tmsg_out) {};

\node[place,tokens=0,label=right:$q_1$] at (1,-3) (p1) {};
\node[transition,rotate=90,label={[yshift=0,xshift=0]90:$\transition{in?}$}] at (-1,-3) (ta_in) {};

\node[transition,rotate=90,label={[yshift=0,xshift=0]180:$\transition{\inact{gsm}}$},] at (1,-4.5) (tgsm_in) {};

\node[place,tokens=0,label=below:$q_2$] at (-1,-4.5) (p2) {};



% \node[place,tokens=1,label=above:$r_0$] at (6,0) (r0) {};
\node[transition,rotate=90,label={[yshift=0,xshift=0]0:$\transition{\inact{msg}}$}] at (7,-1.5) (tmsg_in) {};

\node[place,tokens=0,label=left:$r_1$] at (7,-3) (r1) {};
\node[place,tokens=1,label=left:$r_0$] at (9,-3) (r0) {};
% \node[transition,rotate=90,label={[yshift=0,xshift=0]-90:$\transition{out!}$},fill=red] at (7,-3) (tb_out) {};

\node[transition,rotate=90,label={[yshift=0,xshift=0]180:$\transition{\outact{gsm}}$},] at (7,-4.5) (tgsm_out) {};
% \node[place,tokens=0,label=above:$r_2$] at (6,-6) (r2) {};


\node[place,tokens=0,label=below:$\channel{msg}$] at (4,-1.5) (msg) {};
\node[place,tokens=0,label=below:$\channel{gsm}$] at (4,-4.5) (gsm) {};

\draw[arc] (p0) to[] (tmsg_out) {};
\draw[arc] (tmsg_out) to[] (p1) {};

\draw[arc] (p1) to[] (tgsm_in) {};
\draw[arc] (tgsm_in) to[] (p2) {};

\draw[arc] (p2) to[bend left=0] (ta_in) {};
\draw[arc] (ta_in) to[bend left=0] (p0) {};

\draw[arc] (tmsg_out) -- (msg) {};
\draw[arc] (msg) -- (tmsg_in) {};

\draw[arc] (tgsm_out) -- (gsm) {};
\draw[arc] (gsm) -- (tgsm_in) {};

\draw[arc] (r0) to[bend right] (tmsg_in) {};
\draw[arc] (tmsg_in) to (r1) {};

\draw[arc] (r1) to (tgsm_out) {};
% \draw[arc] (tgsm_out) to[bend right] (r2) {};
\draw[arc] (tgsm_out) to[bend right] (r0) {};

% \draw[arc] (r2) to[bend right=18] (tb_out) {};
% \draw[arc] (tb_out) to[bend right=18] (r0) {};
% \node[above of=p0] {$\mathcal M_1$};
% \node[above of=r0] {$\mathcal M_2$};

\begin{pgfonlayer}{background}
\node [compBackground,inner sep=8mm,fit=(p0) (p1) (p2) (tmsg_out) (ta_in) (tgsm_in)] {};
\node [compBackground,inner sep=8mm,fit=(r0) (r1) (tmsg_in) (tgsm_out)] {};
\end{pgfonlayer}
\end{tikzpicture}